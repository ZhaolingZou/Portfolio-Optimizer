<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Interactive Portfolio Optimizer</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
      * {
          margin: 0;
          padding: 0;
          box-sizing: border-box;
      }

      body {
          font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
          background: linear-gradient(135deg, #e8f2ed 0%, #d9ebe1 50%, #c7dfd0 100%);
          min-height: 100vh;
          color: #4a5568;
      }

      .container {
          max-width: 1200px;
          margin: 0 auto;
          padding: 20px;
      }

      header {
          text-align: center;
          margin-bottom: 40px;
          color: #2d5a3d;
      }

      header h1 {
          font-size: 3rem;
          margin-bottom: 10px;
          text-shadow: 1px 1px 3px rgba(45, 90, 61, 0.15);
      }

      header p {
          font-size: 1.2rem;
          opacity: 0.85;
          color: #4a6b57;
      }

      .main-content {
          display: grid;
          gap: 30px;
      }

      .panel {
          background: rgba(255, 255, 255, 0.95);
          border-radius: 20px;
          padding: 30px;
          box-shadow: 0 15px 35px rgba(118, 150, 130, 0.12);
          backdrop-filter: blur(10px);
          border: 1px solid rgba(199, 223, 208, 0.4);
          transition: transform 0.3s ease, box-shadow 0.3s ease;
      }

      .panel:hover {
          transform: translateY(-5px);
          box-shadow: 0 20px 40px rgba(118, 150, 130, 0.18);
      }

      .panel h2 {
          color: #2d5a3d;
          margin-bottom: 25px;
          font-size: 1.8rem;
          display: flex;
          align-items: center;
          gap: 10px;
      }

      .panel h2::before {
          content: '';
          width: 4px;
          height: 30px;
          background: linear-gradient(45deg, #7a9b87, #6b8a78);
          border-radius: 2px;
      }

      .form-group {
          margin-bottom: 20px;
      }

      .form-row {
          display: grid;
          grid-template-columns: 1fr 1fr;
          gap: 20px;
      }

      label {
          display: block;
          margin-bottom: 8px;
          font-weight: 600;
          color: #4a6b57;
      }

      input[type="text"], 
      input[type="date"], 
      textarea {
          width: 100%;
          padding: 12px 16px;
          border: 2px solid #d9ebe1;
          border-radius: 12px;
          font-size: 16px;
          transition: all 0.3s ease;
          background: #f4f9f6;
          color: #4a5568;
      }

      input[type="text"]:focus, 
      input[type="date"]:focus, 
      textarea:focus {
          outline: none;
          border-color: #7a9b87;
          background: white;
          box-shadow: 0 0 0 3px rgba(122, 155, 135, 0.12);
      }

      .btn {
          padding: 14px 28px;
          border: none;
          border-radius: 12px;
          font-size: 16px;
          font-weight: 600;
          cursor: pointer;
          transition: all 0.3s ease;
          text-transform: uppercase;
          letter-spacing: 0.5px;
          margin: 5px;
      }

      .btn.primary {
          background: linear-gradient(45deg, #7a9b87, #6b8a78);
          color: white;
          box-shadow: 0 4px 15px rgba(122, 155, 135, 0.25);
      }

      .btn.primary:hover {
          transform: translateY(-2px);
          box-shadow: 0 8px 25px rgba(122, 155, 135, 0.35);
          background: linear-gradient(45deg, #6b8a78, #5c7a69);
      }

      .btn.primary:active {
          transform: translateY(0);
      }

      .btn.secondary {
          background: linear-gradient(45deg, #8fbc8f, #7a9b87);
          color: white;
          box-shadow: 0 4px 15px rgba(143, 188, 143, 0.25);
      }

      .btn.secondary:hover {
          transform: translateY(-2px);
          box-shadow: 0 8px 25px rgba(143, 188, 143, 0.35);
      }

      .btn.outline {
          background: transparent;
          border: 2px solid #7a9b87;
          color: #7a9b87;
      }

      .btn.outline:hover {
          background: #7a9b87;
          color: white;
      }

      .btn:disabled {
          opacity: 0.6;
          cursor: not-allowed;
          transform: none;
      }

      .button-group {
          display: flex;
          gap: 10px;
          margin-bottom: 20px;
          flex-wrap: wrap;
      }

      .status-message {
          margin-top: 15px;
          padding: 12px;
          border-radius: 8px;
          font-weight: 500;
      }

      .status-message.success {
          background: #edf5f0;
          color: #2d5a3d;
          border: 1px solid #c7dfd0;
      }

      .status-message.error {
          background: #f5f0f0;
          color: #8b5a5a;
          border: 1px solid #e0c8c8;
      }

      /* Pareto Solutions Section */
      .pareto-section {
          margin-top: 20px;
      }

      .section-description {
          color: #4a6b57;
          margin-bottom: 20px;
          font-size: 1.1em;
          line-height: 1.6;
      }

      .solutions-grid {
          display: grid;
          grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
          gap: 20px;
          margin-top: 20px;
      }

      .pareto-solution {
          background: #f4f9f6;
          border-radius: 15px;
          padding: 20px;
          border: 2px solid transparent;
          transition: all 0.3s ease;
          cursor: pointer;
      }

      .pareto-solution:hover {
          border-color: #7a9b87;
          box-shadow: 0 8px 25px rgba(122, 155, 135, 0.2);
          transform: translateY(-3px);
      }

      .solution-header {
          display: flex;
          justify-content: space-between;
          align-items: center;
          margin-bottom: 15px;
      }

      .solution-header h4 {
          color: #2d5a3d;
          margin: 0;
          font-size: 1.2rem;
      }

      .select-solution-btn {
          background: linear-gradient(45deg, #7a9b87, #6b8a78);
          color: white;
          border: none;
          padding: 8px 16px;
          border-radius: 8px;
          cursor: pointer;
          font-size: 14px;
          font-weight: 600;
          transition: all 0.3s ease;
      }

      .select-solution-btn:hover {
          background: linear-gradient(45deg, #6b8a78, #5c7a69);
          transform: translateY(-1px);
      }

      .solution-metrics {
          display: grid;
          grid-template-columns: 1fr 1fr;
          gap: 10px;
          margin-bottom: 15px;
      }

      .metric {
          display: flex;
          justify-content: space-between;
          padding: 8px 12px;
          background: white;
          border-radius: 8px;
          border: 1px solid #d9ebe1;
      }

      .metric-label {
          font-weight: 600;
          color: #4a6b57;
          font-size: 14px;
      }

      .metric-value {
          font-weight: 700;
          color: #2d5a3d;
          font-size: 14px;
      }

      .solution-weights h5 {
          margin-bottom: 10px;
          color: #2d5a3d;
          font-size: 1rem;
      }

      .weights-grid {
          display: grid;
          grid-template-columns: repeat(auto-fit, minmax(70px, 1fr));
          gap: 8px;
      }

      .weight-item {
          background: white;
          padding: 8px;
          border-radius: 8px;
          text-align: center;
          font-size: 12px;
          border: 1px solid #d9ebe1;
      }

      .ticker {
          font-weight: 700;
          color: #2d5a3d;
          display: block;
      }

      .weight {
          color: #7a9b87;
          font-weight: 600;
          margin-top: 2px;
      }

      .chart-container {
          background: white;
          padding: 20px;
          border-radius: 15px;
          margin: 20px 0;
          box-shadow: 0 4px 15px rgba(122, 155, 135, 0.12);
          border: 1px solid #d9ebe1;
      }

      .chart-container canvas {
          max-height: 400px;
      }

      .chat-container {
          max-height: 400px;
          overflow-y: auto;
          border: 2px solid #d9ebe1;
          border-radius: 12px;
          padding: 20px;
          margin-bottom: 20px;
          background: #f4f9f6;
      }

      .chat-message {
          margin-bottom: 15px;
          padding: 12px 16px;
          border-radius: 12px;
          max-width: 80%;
          animation: fadeIn 0.3s ease;
      }

      @keyframes fadeIn {
          from { opacity: 0; transform: translateY(10px); }
          to { opacity: 1; transform: translateY(0); }
      }

      .chat-message.user {
          background: linear-gradient(45deg, #7a9b87, #6b8a78);
          color: white;
          margin-left: auto;
      }

      .chat-message.ai {
          background: #edf5f0;
          color: #2d5a3d;
      }

      .chat-input-container {
          display: flex;
          gap: 15px;
          align-items: flex-end;
      }

      .chat-input-container textarea {
          flex: 1;
          resize: vertical;
      }

      .results-section {
          margin-bottom: 30px;
          padding: 20px;
          background: #f4f9f6;
          border-radius: 12px;
          border-left: 4px solid #7a9b87;
      }

      .results-section h3 {
          color: #2d5a3d;
          margin-bottom: 15px;
          font-size: 1.3rem;
      }

      .weights-container {
          display: grid;
          grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
          gap: 15px;
          margin-bottom: 20px;
      }

      .weights-container .weight-item {
          background: white;
          padding: 15px;
          border-radius: 10px;
          text-align: center;
          box-shadow: 0 2px 10px rgba(122, 155, 135, 0.12);
          border: 1px solid #d9ebe1;
      }

      .weights-container .weight-item .ticker {
          font-weight: bold;
          color: #6b8a78;
          font-size: 1.1rem;
      }

      .weights-container .weight-item .percentage {
          font-size: 1.5rem;
          font-weight: bold;
          color: #2d5a3d;
          margin-top: 5px;
      }

      .metrics-container {
          display: grid;
          grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
          gap: 20px;
      }

      .metric-card {
          background: white;
          padding: 20px;
          border-radius: 12px;
          text-align: center;
          box-shadow: 0 4px 15px rgba(122, 155, 135, 0.12);
          border: 1px solid #d9ebe1;
      }

      .metric-card .label {
          color: #7a9b87;
          font-size: 0.9rem;
          text-transform: uppercase;
          letter-spacing: 0.5px;
          margin-bottom: 8px;
      }

      .metric-card .value {
          font-size: 2rem;
          font-weight: bold;
          color: #2d5a3d;
      }

      .preferences-container {
          display: flex;
          flex-wrap: wrap;
          gap: 10px;
      }

      .preference-tag {
          background: linear-gradient(45deg, #7a9b87, #6b8a78);
          color: white;
          padding: 8px 16px;
          border-radius: 20px;
          font-size: 0.9rem;
          font-weight: 500;
      }

      .preferences-display {
          display: grid;
          grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
          gap: 15px;
          margin-top: 15px;
      }

      .preference-item {
          display: flex;
          justify-content: space-between;
          align-items: center;
          background: white;
          padding: 15px;
          border-radius: 8px;
          box-shadow: 0 2px 5px rgba(122, 155, 135, 0.1);
          border: 1px solid #d9ebe1;
      }

      .preference-label {
          font-weight: 600;
          color: #4a6b57;
      }

      .preference-value {
          font-weight: 700;
          color: #2d5a3d;
          font-size: 1.1em;
      }

      .loading-overlay {
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background: rgba(118, 150, 130, 0.75);
          display: flex;
          flex-direction: column;
          justify-content: center;
          align-items: center;
          z-index: 1000;
          backdrop-filter: blur(5px);
      }

      .spinner {
          width: 50px;
          height: 50px;
          border: 4px solid rgba(255,255,255,0.3);
          border-top: 4px solid white;
          border-radius: 50%;
          animation: spin 1s linear infinite;
          margin-bottom: 20px;
      }

      @keyframes spin {
          0% { transform: rotate(0deg); }
          100% { transform: rotate(360deg); }
      }

      .loading-overlay p {
          color: white;
          font-size: 1.2rem;
          font-weight: 500;
      }

      #portfolio-chart {
          max-width: 100%;
          height: auto;
          margin-top: 20px;
      }

      @media (max-width: 768px) {
          .container {
              padding: 15px;
          }

          header h1 {
              font-size: 2rem;
          }

          .form-row {
              grid-template-columns: 1fr;
          }

          .chat-input-container {
              flex-direction: column;
          }

          .weights-container,
          .metrics-container {
              grid-template-columns: 1fr;
          }

          .solutions-grid {
              grid-template-columns: 1fr;
          }

          .solution-metrics {
              grid-template-columns: 1fr;
          }

          .button-group {
              flex-direction: column;
          }

          .btn {
              width: 100%;
              margin: 5px 0;
          }
      }

      /* Smooth animations */
      .panel {
          animation: fadeInUp 0.6s ease-out;
      }

      @keyframes fadeInUp {
          from {
              opacity: 0;
              transform: translateY(30px);
          }
          to {
              opacity: 1;
              transform: translateY(0);
          }
      }

      /* Custom scrollbar */
      .chat-container::-webkit-scrollbar {
          width: 8px;
      }

      .chat-container::-webkit-scrollbar-track {
          background: #f4f9f6;
          border-radius: 4px;
      }

      .chat-container::-webkit-scrollbar-thumb {
          background: #7a9b87;
          border-radius: 4px;
      }

      .chat-container::-webkit-scrollbar-thumb:hover {
          background: #6b8a78;
      }
  </style>
</head>
<body>
  <div class="container">
      <header>
          <h1>Interactive Portfolio Optimizer</h1>
          <p>AI-Powered Multi-Objective Investment Assistant</p>
      </header>

      <div class="main-content">
          <!-- Initialization Panel -->
          <div id="init-panel" class="panel">
              <h2>Initialize System</h2>
              <div class="form-group">
                  <label>Stock Tickers (comma-separated):</label>
                  <input type="text" id="tickers" value="AAPL,MSFT,GOOGL,AMZN,TSLA,META,NVDA,JPM" placeholder="AAPL,MSFT,GOOGL...">
              </div>
              <div class="form-row">
                  <div class="form-group">
                      <label>Start Date:</label>
                      <input type="date" id="start-date" value="2020-01-01">
                  </div>
                  <div class="form-group">
                      <label>End Date:</label>
                      <input type="date" id="end-date" value="2024-01-01">
                  </div>
              </div>
              <button id="init-btn" class="btn primary">Initialize Portfolio System</button>
              <div id="init-status" class="status-message"></div>
          </div>

          <!-- Control Panel -->
          <div id="control-panel" class="panel" style="display: none;">
              <h2>Optimization Control</h2>
              <div class="button-group">
                  <button id="generate-pareto-btn" class="btn primary">
                       Generate Pareto Solutions
                  </button>
                  <button id="optimize-btn" class="btn secondary">
                       Optimize with Preferences
                  </button>
                  <button id="reset-btn" class="btn outline">
                       Reset Process
                  </button>
              </div>
              
              <!-- Current Preferences Display -->
              <div id="current-preferences-section" class="results-section" style="display: none;">
                  <h3>Current Preferences</h3>
                  <div id="current-preferences" class="preferences-display">
                  </div>
              </div>
          </div>

          <!-- Pareto Solutions Section -->
          <div id="pareto-solutions" class="panel pareto-section" style="display: none;">
              <h2> Pareto Optimal Solutions</h2>
              <p class="section-description">
                  Below are different optimal portfolios representing various trade-offs between return, risk, and liquidity. 
                  Select the one that best matches your preferences:
              </p>
              
              <!-- Pareto Chart -->
              <div class="chart-container">
                  <canvas id="pareto-chart"></canvas>
              </div>
              
              <!-- Solutions Grid -->
              <div id="solutions-container" class="solutions-grid">
              </div>
          </div>

          <!-- Chat Interface -->
          <div id="chat-panel" class="panel" style="display: none;">
              <h2>Tell me your investment preferences</h2>
              <div id="chat-messages" class="chat-container">
                  <div class="chat-message ai">
                      <strong>AI Assistant:</strong> Hello! I'm here to help you create an optimized investment portfolio. Please tell me about your investment preferences, risk tolerance, and financial goals. For example:
                      <br><br>
                      • "I want a conservative portfolio with low risk"
                      <br>• "I'm looking for high growth potential"
                      <br>• "I prefer dividend-paying stocks"
                      <br>• "I want balanced risk and return"
                  </div>
              </div>
              <div class="chat-input-container">
                  <textarea id="user-input" placeholder="Example: I want a conservative portfolio with low risk and steady returns..." rows="3"></textarea>
                  <button id="send-btn" class="btn primary">Send</button>
              </div>
          </div>

          <!-- Results Panel -->
          <div id="results-panel" class="panel" style="display: none;">
              <h2>Optimized Portfolio</h2>
              
              <!-- Portfolio Weights -->
              <div class="results-section">
                  <h3>Portfolio Allocation</h3>
                  <div id="portfolio-weights" class="weights-container"></div>
                  <canvas id="portfolio-chart" width="400" height="200"></canvas>
              </div>

              <!-- Performance Metrics -->
              <div class="results-section">
                  <h3>Performance Metrics</h3>
                  <div id="portfolio-metrics" class="metrics-container"></div>
              </div>
          </div>
      </div>

      <!-- Loading Overlay -->
      <div id="loading-overlay" class="loading-overlay" style="display: none;">
          <div class="spinner"></div>
          <p>Processing your request...</p>
      </div>
  </div>

  <script>
    class PortfolioOptimizer {
        constructor() {
            this.initialized = false;
            this.currentPreferences = null;
            this.portfolioChart = null;
            this.paretoChart = null;
            this.optimizationStage = 'initial';
            this.paretoSolutions = null;
            this.initializeEventListeners();
        }

        initializeEventListeners() {
            // Initialize button
            document.getElementById('init-btn').addEventListener('click', () => {
                this.initializeSystem();
            });

            // Generate Pareto frontier button
            document.getElementById('generate-pareto-btn').addEventListener('click', () => {
                this.generateParetoFrontier();
            });

            // Optimize with preferences button
            document.getElementById('optimize-btn').addEventListener('click', () => {
                this.optimizeWithPreferences();
            });

            // Reset optimization button
            document.getElementById('reset-btn').addEventListener('click', () => {
                this.resetOptimization();
            });

            // Send message button
            document.getElementById('send-btn').addEventListener('click', () => {
                this.sendMessage();
            });

            // Enter key in textarea
            document.getElementById('user-input').addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    this.sendMessage();
                }
            });
        }

        async initializeSystem() {
            const initBtn = document.getElementById('init-btn');
            const statusDiv = document.getElementById('init-status');
            
            try {
                initBtn.disabled = true;
                initBtn.textContent = 'Initializing...';
                this.showLoading();

                const tickers = document.getElementById('tickers').value
                    .split(',')
                    .map(t => t.trim().toUpperCase())
                    .filter(t => t.length > 0);
                
                const startDate = document.getElementById('start-date').value;
                const endDate = document.getElementById('end-date').value;

                const response = await fetch('/api/initialize', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        tickers: tickers,
                        start_date: startDate,
                        end_date: endDate
                    })
                });

                const data = await response.json();

                if (data.success) {
                    this.initialized = true;
                    this.hidePanel('init-panel');
                    this.showPanel('control-panel');
                    this.showPanel('chat-panel');
                    this.addSystemMessage(data.message);
                    this.addSystemMessage(`Data loaded: ${data.data_info.n_tickers} stocks from ${data.data_info.date_range.start} to ${data.data_info.date_range.end}`);
                    this.optimizationStage = 'initial';
                } else {
                    statusDiv.innerHTML = `<div class="error">Error: ${data.message}</div>`;
                    statusDiv.className = 'status-message error';
                }

            } catch (error) {
                statusDiv.innerHTML = `Network error: ${error.message}`;
                statusDiv.className = 'status-message error';
            } finally {
                this.hideLoading();
                initBtn.disabled = false;
                initBtn.textContent = 'Initialize Portfolio System';
            }
        }

        async generateParetoFrontier() {
            if (!this.initialized) {
                this.addSystemMessage("Please initialize the system first.");
                return;
            }

            try {
                this.showLoading();
                this.addSystemMessage("Generating Pareto optimal solutions... This may take a moment.");

                const response = await fetch('/api/generate_pareto', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({})
                });

                const data = await response.json();

                if (data.success) {
                    this.paretoSolutions = data.pareto_solutions;
                    this.optimizationStage = 'pareto_selection';
                    
                    this.addSystemMessage(data.message);
                    this.displayParetoSolutions(data.pareto_solutions);
                    this.addSystemMessage("Please select one of the solutions above that best matches your preferences, or you can directly optimize with custom preferences.");
                } else {
                    this.addSystemMessage(`Error: ${data.message}`);
                }

            } catch (error) {
                this.addSystemMessage(`Network error: ${error.message}`);
            } finally {
                this.hideLoading();
            }
        }

        displayParetoSolutions(solutions) {
            const paretoPanel = document.getElementById('pareto-solutions');
            const solutionsContainer = document.getElementById('solutions-container');
            
            solutionsContainer.innerHTML = '';
            
            solutions.forEach((solution, index) => {
                const solutionDiv = document.createElement('div');
                solutionDiv.className = 'pareto-solution';
                solutionDiv.innerHTML = `
                    <div class="solution-header">
                        <h4>Solution ${index + 1}</h4>
                        <button class="select-solution-btn" onclick="portfolioOptimizer.selectParetoSolution(${solution.id})">
                            Select This Portfolio
                        </button>
                    </div>
                    <div class="solution-metrics">
                        <div class="metric">
                            <span class="metric-label">Expected Return:</span>
                            <span class="metric-value">${(solution.metrics.return * 100).toFixed(2)}%</span>
                        </div>
                        <div class="metric">
                            <span class="metric-label">Risk (Volatility):</span>
                            <span class="metric-value">${(solution.metrics.risk * 100).toFixed(2)}%</span>
                        </div>
                        <div class="metric">
                            <span class="metric-label">Liquidity Score:</span>
                            <span class="metric-value">${solution.metrics.liquidity.toFixed(3)}</span>
                        </div>
                    </div>
                    <div class="solution-weights">
                        <h5>Portfolio Allocation:</h5>
                        <div class="weights-grid">
                            ${Object.entries(solution.weights)
                                .sort((a, b) => b[1] - a[1])
                                .map(([ticker, weight]) => `
                                    <div class="weight-item">
                                        <span class="ticker">${ticker}</span>
                                        <span class="weight">${(weight * 100).toFixed(1)}%</span>
                                    </div>
                                `).join('')}
                        </div>
                    </div>
                `;
                solutionsContainer.appendChild(solutionDiv);
            });
            
            paretoPanel.style.display = 'block';
            
            // Create Pareto frontier visualization
            this.createParetoChart(solutions);
        }

        createParetoChart(solutions) {
            const ctx = document.getElementById('pareto-chart');
            if (!ctx) return;

            if (this.paretoChart) {
                this.paretoChart.destroy();
                this.paretoChart = null; 
            }

            const liquidityValues = solutions.map(sol => sol.metrics.liquidity);
            const minLiquidity = Math.min(...liquidityValues);
            const maxLiquidity = Math.max(...liquidityValues);
            const liquidityRange = maxLiquidity - minLiquidity;

            // Prepare data for visualization
            const data = solutions.map((sol, index) => {
                const normalizedLiquidity = liquidityRange > 0 ? 
                    (sol.metrics.liquidity - minLiquidity) / liquidityRange : 0.5;
                const enhancedSize = 8 + Math.pow(normalizedLiquidity, 2) * 32;
                
                return {
                    x: sol.metrics.risk * 100,
                    y: sol.metrics.return * 100,
                    r: enhancedSize,
                    label: `Solution ${index + 1}`,
                    liquidity: sol.metrics.liquidity,
                    liquidityRank: Math.round(normalizedLiquidity * 100),
                    id: sol.id
                };
            });

            this.paretoChart = new Chart(ctx, {
                type: 'bubble',
                data: {
                    datasets: [{
                        label: 'Pareto Optimal Solutions',
                        data: data,
                        backgroundColor: function(context) {
                            const liquidity = context.raw.liquidity;
                            const normalizedLiquidity = liquidityRange > 0 ? 
                                (liquidity - minLiquidity) / liquidityRange : 0.5;
                            const alpha = 0.3 + normalizedLiquidity * 0.7;
                            return `rgba(122, 155, 135, ${alpha})`;
                        },
                        borderColor: function(context) {
                            const liquidity = context.raw.liquidity;
                            const normalizedLiquidity = liquidityRange > 0 ? 
                                (liquidity - minLiquidity) / liquidityRange : 0.5;
                            const alpha = 0.5 + normalizedLiquidity * 0.5;
                            return `rgba(122, 155, 135, ${alpha})`;
                        },
                        borderWidth: 2,
                        pointHoverRadius: function(context) {
                            return context.raw.r * 1.3;
                        }
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Multi-Objective Portfolio Solutions (Risk vs Return vs Liquidity)',
                            color: '#2d5a3d',
                            font: {
                                size: 16,
                                weight: 'bold'
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const point = context.raw;
                                    return [
                                        `${point.label}`,
                                        `Return: ${point.y.toFixed(2)}%`,
                                        `Risk: ${point.x.toFixed(2)}%`,
                                        `Liquidity: ${point.liquidity.toFixed(4)}`,
                                        `Liquidity Rank: ${point.liquidityRank}%`,
                                        `(Larger bubble = Higher liquidity)`
                                    ];
                                }
                            }
                        },
                        legend: {
                            display: true,
                            labels: {
                                generateLabels: function(chart) {
                                    return [{
                                        text: 'Portfolio Solutions (Size ∝ Liquidity²)',
                                        fillStyle: 'rgba(122, 155, 135, 0.6)',
                                        strokeStyle: 'rgba(122, 155, 135, 1)',
                                        pointStyle: 'circle'
                                    }];
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Risk (Volatility %)',
                                color: '#4a6b57'
                            },
                            grid: {
                                color: 'rgba(122, 155, 135, 0.2)'
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Expected Return (%)',
                                color: '#4a6b57'
                            },
                            grid: {
                                color: 'rgba(122, 155, 135, 0.2)'
                            }
                        }
                    },
                    onClick: (event, elements) => {
                        if (elements.length > 0) {
                            const index = elements[0].index;
                            const solutionId = data[index].id;
                            this.selectParetoSolution(solutionId);
                        }
                    }
                }
            });
        }


        async selectParetoSolution(solutionId) {
            try {
                this.showLoading();
                this.addSystemMessage(`Analyzing your selection...`);

                const response = await fetch('/api/select_pareto_solution', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        solution_id: solutionId
                    })
                });

                const data = await response.json();

                if (data.success) {
                    this.currentPreferences = data.extracted_preferences;
                    this.optimizationStage = 'preference_refinement';
                    
                    this.addSystemMessage(data.message);
                    this.displayPreferences(data.extracted_preferences);
                    
                    // Hide Pareto solutions
                    this.hidePanel('pareto-solutions');
                    
                    // Automatically optimize with extracted preferences
                    await this.optimizeWithPreferences();
                    
                    this.addSystemMessage("Based on your selection, I've optimized a portfolio. Are you satisfied with this result? If not, please tell me how you'd like to adjust your preferences.");
                } else {
                    this.addSystemMessage(`Error: ${data.message}`);
                }

            } catch (error) {
                this.addSystemMessage(`Network error: ${error.message}`);
            } finally {
                this.hideLoading();
            }
        }

        async optimizeWithPreferences() {
            if (!this.initialized) {
                this.addSystemMessage("Please initialize the system first.");
                return;
            }

            try {
                this.showLoading();
                this.addSystemMessage("Optimizing portfolio with current preferences...");

                const response = await fetch('/api/optimize_with_preferences', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        preferences: this.currentPreferences,
                        method: 'tchebycheff'
                    })
                });

                const data = await response.json();

                if (data.success) {
                    this.addSystemMessage(`${data.message} (Iteration ${data.iteration})`);
                    this.displayOptimizationResult(data.result);
                } else {
                    this.addSystemMessage(`Error: ${data.message}`);
                }

            } catch (error) {
                this.addSystemMessage(`Network error: ${error.message}`);
            } finally {
                this.hideLoading();
            }
        }

        async sendMessage() {
            const userInput = document.getElementById('user-input');
            const message = userInput.value.trim();
            
            if (!message) return;

            this.addUserMessage(message);
            userInput.value = '';

            try {
                this.showLoading();

                const response = await fetch('/api/refine_preferences', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        user_input: message
                    })
                });

                const data = await response.json();

                if (data.success) {
                    this.currentPreferences = data.refined_preferences;
                    this.addSystemMessage(data.message);
                    this.displayPreferences(data.refined_preferences);
                    
                    if (data.explanation) {
                        this.addSystemMessage(data.explanation);
                    }
                    
                    // Automatically optimize with refined preferences
                    await this.optimizeWithPreferences();
                } else {
                    this.addSystemMessage(`Error: ${data.message}`);
                }

            } catch (error) {
                this.addSystemMessage(`Network error: ${error.message}`);
            } finally {
                this.hideLoading();
            }
        }

        async resetOptimization() {
            try {
                const response = await fetch('/api/reset_optimization', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });

                const data = await response.json();

                if (data.success) {
                    this.optimizationStage = 'initial';
                    this.paretoSolutions = null;
                    this.currentPreferences = null;
                    
                    // Clear UI
                    this.hidePanel('pareto-solutions');
                    this.hidePanel('results-panel');
                    this.hidePanel('current-preferences-section');
                    document.getElementById('chat-messages').innerHTML = `
                        <div class="chat-message ai">
                            <strong>AI Assistant:</strong> Hello! I'm here to help you create an optimized investment portfolio. Please tell me about your investment preferences, risk tolerance, and financial goals. For example:
                            <br><br>
                            • "I want a conservative portfolio with low risk"
                            <br>• "I'm looking for high growth potential"
                            <br>• "I prefer dividend-paying stocks"
                            <br>• "I want balanced risk and return"
                        </div>
                    `;
                    
                    this.addSystemMessage(data.message);
                    this.addSystemMessage("You can now start fresh by generating Pareto solutions or directly optimizing with preferences.");
                } else {
                    this.addSystemMessage(`Error: ${data.message}`);
                }

            } catch (error) {
                this.addSystemMessage(`Network error: ${error.message}`);
            }
        }

        displayPreferences(preferences) {
            const preferencesSection = document.getElementById('current-preferences-section');
            const preferencesDiv = document.getElementById('current-preferences');
            
            preferencesDiv.innerHTML = `
                <div class="preference-item">
                    <span class="preference-label">Return Focus:</span>
                    <span class="preference-value">${(preferences.return * 100).toFixed(1)}%</span>
                </div>
                <div class="preference-item">
                    <span class="preference-label">Risk Tolerance:</span>
                    <span class="preference-value">${(preferences.risk * 100).toFixed(1)}%</span>
                </div>
                <div class="preference-item">
                    <span class="preference-label">Liquidity Focus:</span>
                    <span class="preference-value">${(preferences.liquidity * 100).toFixed(1)}%</span>
                </div>
            `;
            preferencesSection.style.display = 'block';
        }

        displayOptimizationResult(result) {
            const resultsPanel = document.getElementById('results-panel');
            const weightsContainer = document.getElementById('portfolio-weights');
            const metricsContainer = document.getElementById('portfolio-metrics');
            
            // Display portfolio weights
            weightsContainer.innerHTML = Object.entries(result.weights)
                .sort((a, b) => b[1] - a[1])
                .map(([ticker, weight]) => `
                    <div class="weight-item">
                        <div class="ticker">${ticker}</div>
                        <div class="percentage">${(weight * 100).toFixed(1)}%</div>
                    </div>
                `).join('');

            // Display portfolio metrics - remove Sharpe Ratio
            metricsContainer.innerHTML = `
                <div class="metric-card">
                    <div class="label">Expected Return</div>
                    <div class="value">${(result.metrics.return * 100).toFixed(2)}%</div>
                </div>
                <div class="metric-card">
                    <div class="label">Risk (Volatility)</div>
                    <div class="value">${(result.metrics.risk * 100).toFixed(2)}%</div>
                </div>
                <div class="metric-card">
                    <div class="label">Liquidity Score</div>
                    <div class="value">${result.metrics.liquidity.toFixed(3)}</div>
                </div>
            `;

            resultsPanel.style.display = 'block';
            
            // Create portfolio chart
            this.createPortfolioChart(result.weights);
        }

        createPortfolioChart(weights) {
            const ctx = document.getElementById('portfolio-chart');
            if (!ctx) return;

            if (this.portfolioChart) {
                this.portfolioChart.destroy();
            }

            const sortedWeights = Object.entries(weights)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 10); // Show top 10 holdings

            this.portfolioChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: sortedWeights.map(([ticker]) => ticker),
                    datasets: [{
                        data: sortedWeights.map(([, weight]) => weight * 100),
                        backgroundColor: [
                            '#7a9b87', '#6b8a78', '#8fbc8f', '#5c7a69',
                            '#9caf88', '#7d9b7d', '#a8c8a8', '#6f8a6f',
                            '#b5d6b5', '#8db58d', '#c2e2c2', '#a0c5a0'
                        ],
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Portfolio Allocation',
                            color: '#2d5a3d',
                            font: {
                                size: 16,
                                weight: 'bold'
                            }
                        },
                        legend: {
                            position: 'right',
                            labels: {
                                color: '#4a6b57'
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `${context.label}: ${context.parsed.toFixed(1)}%`;
                                }
                            }
                        }
                    }
                }
            });
        }

        addUserMessage(message) {
            this.addMessage(message, 'user');
        }

        addSystemMessage(message) {
            this.addMessage(message, 'ai');
        }

        addMessage(message, sender) {
            const chatMessages = document.getElementById('chat-messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `chat-message ${sender}`;
            
            if (sender === 'ai') {
                messageDiv.innerHTML = `<strong>AI Assistant:</strong> ${message}`;
            } else {
                messageDiv.innerHTML = message;
            }
            
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        showLoading() {
            document.getElementById('loading-overlay').style.display = 'flex';
        }

        hideLoading() {
            document.getElementById('loading-overlay').style.display = 'none';
        }

        showPanel(panelId) {
            document.getElementById(panelId).style.display = 'block';
        }

        hidePanel(panelId) {
            document.getElementById(panelId).style.display = 'none';
        }
    }

    // Initialize the application when the page loads
    document.addEventListener('DOMContentLoaded', function() {
        window.portfolioOptimizer = new PortfolioOptimizer();
    });
  </script>
</body>
</html>

